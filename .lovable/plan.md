

# Admin Dashboard with Supabase Auth & Client CRUD

## Overview
Build a protected admin dashboard at `/admin/*` with Supabase Auth (email/password), a sidebar layout, and a full CRUD interface for managing SME clients. Only your specific email address will have access.

## Prerequisites
- **Lovable Cloud** will be enabled to spin up a Supabase backend
- You will need to **provide your admin email** when prompted during implementation

---

## 1. Enable Lovable Cloud & Database Setup

### Tables to create:

**`admins`** — stores authorized admin user IDs
| Column | Type | Notes |
|--------|------|-------|
| id | uuid (PK) | auto-generated |
| user_id | uuid (FK -> auth.users) | NOT NULL, unique, cascade delete |
| created_at | timestamptz | default now() |

**`clients`** — SME client data
| Column | Type | Notes |
|--------|------|-------|
| id | uuid (PK) | auto-generated |
| name | text | NOT NULL |
| phone | text | NOT NULL |
| industry | text | NOT NULL |
| created_at | timestamptz | default now() |
| updated_at | timestamptz | default now() |

### Security (RLS)
- A `is_admin()` helper function (SECURITY DEFINER) checks if the current user exists in the `admins` table
- All policies on `clients` use `is_admin()` for SELECT, INSERT, UPDATE, DELETE
- No data is accessible to non-admin users

---

## 2. Authentication Flow

### Login Page (`/login`)
- Replace the current placeholder with a real email/password form
- Uses Supabase `signInWithPassword`
- On success, redirect to `/admin`
- On failure, show error toast
- After login, a trigger or edge function checks if the user's email matches the admin email; if not, sign them out immediately

### Auth Guard
- A `ProtectedRoute` wrapper component checks for active Supabase session
- If no session, redirect to `/login`
- If session exists but user is not in `admins` table, sign out and redirect

---

## 3. Dashboard Layout

### Sidebar (using existing Shadcn Sidebar component)
- Logo at top (Mantra horizontal logo)
- Menu items with icons:
  - **Dashboard** (`/admin`) — LayoutDashboard icon
  - **Clients** (`/admin/clients`) — Users icon
  - **Knowledge Base** (`/admin/knowledge`) — BookOpen icon
  - **Logs** (`/admin/logs`) — FileText icon
- User info + Logout button at bottom
- Collapsible on mobile

### Admin Layout Component
- Wraps all `/admin/*` routes
- Contains `SidebarProvider` + `Sidebar` + main content area
- Header bar with `SidebarTrigger` and page title

---

## 4. Dashboard Pages

### Overview (`/admin`)
- Welcome message with admin email
- Quick stats cards (placeholder): Total Clients, Active this month, etc.
- Recent activity placeholder

### Clients (`/admin/clients`) — Full CRUD
- **List view**: Table with columns (Name, Phone, Industry, Created, Actions)
- **Add**: Dialog/sheet form with fields (Name, Phone, Industry) validated with Zod
- **Edit**: Same dialog pre-filled with existing data
- **Delete**: Confirmation alert dialog before deletion
- Uses TanStack Query for data fetching/mutations with optimistic updates
- Search/filter bar at top

### Knowledge Base (`/admin/knowledge`)
- Placeholder page: "Coming Soon" with description

### Logs (`/admin/logs`)
- Placeholder page: "Coming Soon" with description

---

## 5. New Files to Create

```text
src/
  integrations/supabase/        -- auto-generated by Cloud
  components/
    admin/
      AdminSidebar.tsx           -- sidebar with nav items
      AdminLayout.tsx            -- layout wrapper (sidebar + content)
      ProtectedRoute.tsx         -- auth guard component
      ClientForm.tsx             -- reusable form for add/edit client
      ClientDeleteDialog.tsx     -- delete confirmation
  pages/
    Login.tsx                    -- updated with real auth form
    admin/
      Dashboard.tsx              -- overview page
      Clients.tsx                -- CRUD table + dialogs
      KnowledgeBase.tsx          -- placeholder
      Logs.tsx                   -- placeholder
  hooks/
    useAuth.ts                   -- auth state hook
  App.tsx                        -- updated routes
```

## 6. Files to Modify
- `src/App.tsx` — add `/admin/*` routes wrapped in ProtectedRoute
- `src/pages/Login.tsx` — replace placeholder with real login form
- `src/components/landing/Navbar.tsx` — "Juragan" button links to `/login`

---

## Technical Details

### Database Migration (single migration)
```sql
-- is_admin helper
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS boolean
LANGUAGE sql STABLE SECURITY DEFINER
SET search_path = public
AS $$ SELECT EXISTS (
  SELECT 1 FROM public.admins WHERE user_id = auth.uid()
) $$;

-- admins table
CREATE TABLE public.admins (...);
ALTER TABLE public.admins ENABLE ROW LEVEL SECURITY;

-- clients table
CREATE TABLE public.clients (...);
ALTER TABLE public.clients ENABLE ROW LEVEL SECURITY;

-- RLS policies using is_admin()
```

### Admin Seeding
After you sign up with your email, we will insert your user ID into the `admins` table to grant access.

### Client Form Validation (Zod)
```
name: string, required, max 100 chars
phone: string, required, max 20 chars
industry: string, required, max 50 chars
```

